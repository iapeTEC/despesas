<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Minhas Despesas</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
  <style>
    :root { --bg:#f8f8f9; --card:#fff; --fg:#111; --muted:#6b7280; --blue:#0a84ff; --green:#34c759; --goiaba:#ff6b6b; --border:#e5e7eb; --shadow:0 10px 20px rgba(0,0,0,.06); --radius:18px; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,'SF Pro Text',Inter,Roboto,'Segoe UI',system-ui,sans-serif}
    header{position:sticky;top:0;z-index:10;background:var(--bg);padding:14px 16px 8px;border-bottom:1px solid var(--border)} .title{font-weight:700;letter-spacing:.2px} .sub{color:var(--muted);font-size:12px}
    .container{max-width:560px;margin:0 auto;padding:12px} .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin:12px 8px}
    .month-nav{display:flex;align-items:center;justify-content:space-between} .month-btn{width:44px;height:44px;border-radius:50%;border:1px solid var(--border);background:#fff;display:grid;place-items:center;font-size:20px;cursor:pointer}
    .month-label{font-weight:700;font-size:18px} .field{display:flex;flex-direction:column;gap:6px;margin:8px 0} label{font-size:12px;color:var(--muted)} input,select{appearance:none;border:1px solid var(--border);border-radius:12px;padding:12px 14px;font-size:16px;background:#fff}
    .grid{display:grid;gap:10px} .grid-2{grid-template-columns:1fr 1fr} .expense-row{display:grid;grid-template-columns:1.2fr 1fr .8fr auto;gap:8px;align-items:center;margin-top:8px}
    .btn-row{display:flex;gap:10px;flex-wrap:wrap} .btn{border:none;border-radius:14px;padding:12px 16px;font-weight:600;cursor:pointer}
    .btn-blue{background:var(--blue);color:#fff} .btn-green{background:var(--green);color:#fff} .btn-goiaba{background:var(--goiaba);color:#fff} .btn-ghost{background:#fff;border:1px solid var(--border)}
    .add-mini{width:36px;height:36px;border-radius:50%;border:1px dashed var(--border);background:#fff;font-size:22px;display:grid;place-items:center;cursor:pointer}
    .chart-wrap{display:flex;gap:12px;align-items:center;justify-content:space-between} .chart-card{flex:1} .print-fab{width:48px;height:48px;border:none;border-radius:50%;background:#fff;border:1px solid var(--border);box-shadow:var(--shadow);display:grid;place-items:center;cursor:pointer}
    .summary{display:flex;justify-content:space-between;font-weight:700;margin-top:8px} .muted{color:var(--muted)}
    @media(max-width:420px){.expense-row{grid-template-columns:1fr 1fr .8fr auto}.chart-wrap{flex-direction:column;align-items:stretch}.print-fab{align-self:flex-end}}
    @media print{header,.month-nav,.add-mini,.btn-row,.print-fab{display:none!important} body{background:#fff} .card{box-shadow:none;border:1px solid #ddd}}
  </style>
</head>
<body>
  <header>
    <div class="title">Minhas Despesas</div>
    <div class="sub">R√°pido, minimalista, iPhone‚Äëlike</div>
  </header>

  <div class="container">
    <section class="card">
      <div class="month-nav">
        <button class="month-btn" id="prevMonth" aria-label="M√™s anterior">‚óÄ</button>
        <div class="month-label" id="monthLabel">‚Äì</div>
        <button class="month-btn" id="nextMonth" aria-label="Pr√≥ximo m√™s">‚ñ∂</button>
      </div>
    </section>

    <section class="card" id="incomeCard">
      <div class="grid grid-2">
        <div class="field"><label for="salary">Sal√°rio (R$)</label><input id="salary" type="number" inputmode="decimal" placeholder="2600" /></div>
        <div class="field"><label for="extra">Recebimento extra (R$)</label><input id="extra" type="number" inputmode="decimal" placeholder="0" /></div>
      </div>
    </section>

    <section class="card" id="expensesCard">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="font-weight:700">Despesas</div>
        <button class="add-mini" id="addExpense" title="Adicionar despesa">+</button>
      </div>
      <div id="expensesList"></div>
      <div class="btn-row" style="margin-top:10px;">
        <button class="btn btn-blue" id="saveBtn">Enviar</button>
        <button class="btn btn-ghost" id="clearLocal">Limpar rascunho</button>
      </div>
    </section>

    <section class="card chart-card">
      <div class="chart-wrap">
        <canvas id="pie" width="320" height="320" aria-label="Gr√°fico de pizza de despesas"></canvas>
        <button class="print-fab" id="printBtn" title="Imprimir PDF">üñ®Ô∏è</button>
      </div>
      <div class="summary"><div>Total receitas</div><div id="sumIncome">R$ 0,00</div></div>
      <div class="summary"><div>Total despesas</div><div id="sumExpense">R$ 0,00</div></div>
      <div class="summary"><div>Saldo (com carry‚Äëover)</div><div id="balance">R$ 0,00</div></div>
      <div class="muted" style="margin-top:6px;">* O saldo restante de cada m√™s soma ao pr√≥ximo; se negativo, desconta do pr√≥ximo.</div>
    </section>
  </div>

<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbytOpDPxatLKG0swKXgeRaeudl1VLBI5ag4KwEhJ54kwPrTyYG18rBsmtH3CkAA7KyRlw/exec'; // <- cole aqui a URL do Apps Script Web App
const CATEGORIES = ['Aluguel','Passeio','Alimentacao','Compra de manutencao','Medico','gasolina','conserto','roupas','calcado','gadget','telefonia','Assinaturas Mensais','Cantina da Escola','Energia','oferta','Transporte','Internet','√Ågua','IPTU','Educa√ß√£o','Lazer','Presentes','Farm√°cia','Outros'];

let currentYM = toYM(new Date());
let chart;

function toYM(d){const y=d.getFullYear();const m=(d.getMonth()+1+"").padStart(2,'0');return `${y}-${m}`}
function ymToLabel(ym){const [y,m]=ym.split('-').map(Number);const date=new Date(y,m-1,1);return date.toLocaleDateString('pt-BR',{month:'long',year:'numeric'})}
function money(n){return n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}
function el(id){return document.getElementById(id)}

function makeExpenseRow(data={name:'',category:'Alimentacao',amount:''}){
  const row=document.createElement('div');row.className='expense-row';
  row.innerHTML=`<input type="text" placeholder="Nome da despesa" value="${data.name||''}" />
    <select>${CATEGORIES.map(c=>`<option ${c===data.category?'selected':''}>${c}</option>`).join('')}</select>
    <input type="number" inputmode="decimal" placeholder="0,00" value="${data.amount||''}" />
    <button class="btn btn-goiaba" title="Remover">√ó</button>`;
  const delBtn=row.children[3];delBtn.addEventListener('click',()=>row.remove());
  return row;
}

function getExpensesFromDOM(){return[...document.querySelectorAll('#expensesList .expense-row')].map(row=>{const [nameEl,catEl,amtEl]=row.children;return{name:nameEl.value.trim(),category:catEl.value,amount:parseFloat((amtEl.value||'').replace(',','.'))||0}}).filter(x=>x.name||x.amount>0)}

function saveDraft(){const draft={ym:currentYM,salary:parseFloat(el('salary').value||'0')||0,extra:parseFloat(el('extra').value||'0')||0,expenses:getExpensesFromDOM()};localStorage.setItem('financeDraft:'+currentYM,JSON.stringify(draft))}
function loadDraft(){const raw=localStorage.getItem('financeDraft:'+currentYM);if(!raw)return null;try{return JSON.parse(raw)}catch{return null}}

async function fetchMeta(){try{const r=await fetch(WEB_APP_URL+'?action=meta');const j=await r.json();if(j.defaultSalary&&!el('salary').value)el('salary').value=j.defaultSalary}catch(e){}}
async function fetchMonth(ym){const r=await fetch(WEB_APP_URL+'?action=getMonth&ym='+encodeURIComponent(ym));return await r.json()}

// Use text/plain to avoid CORS preflight; server parses JSON string
async function saveMonth(payload){
  const r=await fetch(WEB_APP_URL,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(payload)});
  // Apps Script returns JSON body even with text/plain request
  return await r.json();
}

function renderChart(byCategory){const ctx=el('pie');const labels=Object.keys(byCategory);const data=Object.values(byCategory);const palette=['#0a84ff','#34c759','#ff9f0a','#ff375f','#5e5ce6','#64d2ff','#ffd60a','#32d74b','#bf5af2','#30d158','#ff3b30','#64a70b','#bf7f00','#6e6e73','#ff6b6b'];const bg=labels.map((_,i)=>palette[i%palette.length]);if(chart)chart.destroy();chart=new Chart(ctx,{type:'pie',data:{labels,datasets:[{data,backgroundColor:bg}]},options:{plugins:{legend:{position:'bottom'}},animation:{duration:300}}})}

function renderExpensesList(expenses){const list=el('expensesList');list.innerHTML='';if(!expenses||expenses.length===0){list.appendChild(makeExpenseRow())}else{expenses.forEach(ex=>list.appendChild(makeExpenseRow(ex)))}}

async function loadYM(ym){currentYM=ym;el('monthLabel').textContent=ymToLabel(ym);const data=await fetchMonth(ym);el('salary').value=(data.salary??2600);el('extra').value=(data.extraIncome??0);renderExpensesList(data.expenses||[]);const draft=loadDraft();if(draft){if(draft.salary)el('salary').value=draft.salary;if(draft.extra)el('extra').value=draft.extra;if(draft.expenses&&draft.expenses.length)renderExpensesList(draft.expenses)}el('sumIncome').textContent=money((data.totalIncome||0));el('sumExpense').textContent=money((data.totalExpenses||0));el('balance').textContent=money((data.balance||0));renderChart(data.byCategory||{})}

window.addEventListener('DOMContentLoaded',async()=>{
  await fetchMeta();
  await loadYM(currentYM);
  el('addExpense').addEventListener('click',()=>{el('expensesList').appendChild(makeExpenseRow())});
  el('saveBtn').addEventListener('click',async()=>{try{const payload={ym:currentYM,salary:parseFloat(el('salary').value||'0')||0,extraIncome:parseFloat(el('extra').value||'0')||0,expenses:getExpensesFromDOM()};saveDraft();const res=await saveMonth(payload);if(res&&res.ok){await loadYM(currentYM);alert('Lan√ßamentos salvos!')}else{alert('Falha ao salvar: '+(res&&res.error?res.error:'erro desconhecido'))}}catch(err){alert('Erro de rede ou CORS. Verifique se o Web App est√° publicado como "Anyone with the link".')}});
  el('clearLocal').addEventListener('click',()=>{localStorage.removeItem('financeDraft:'+currentYM);renderExpensesList([])});
  el('printBtn').addEventListener('click',()=>window.print());
  el('prevMonth').addEventListener('click',()=>{const [y,m]=currentYM.split('-').map(Number);const d=new Date(y,m-2,1);loadYM(toYM(d))});
  el('nextMonth').addEventListener('click',()=>{const [y,m]=currentYM.split('-').map(Number);const d=new Date(y,m,1);loadYM(toYM(d))});
  ['salary','extra'].forEach(id=>el(id).addEventListener('input',saveDraft));
  document.getElementById('expensesList').addEventListener('input',e=>{if(e.target.matches('input,select'))saveDraft()});
});
</script>
</body>
</html>
